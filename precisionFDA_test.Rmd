---
title: "precisionFDA"
author: "Pallavi Misra"
date: "6/18/2020"
output:
  html_document: default
  pdf_document: default
---

```{r library, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##### __Dependencies and Requirements__
* R version 4.0.0
* RTools40
* PostgreSQL12
* Download all CDM version 5 vocabularies from Athena.ohdsi.org

#### Packages to install

```{r setup, eval=FALSE}
install.packages('devtools')
install.packages('bit64')
install.packages("DatabaseConnector")
install.packages("usethis")
devtools::install_github("OHDSI/ETL-Synthea")
install.packages("drat")
drat::addRepo("OHDSI")
install.packages("PatientLevelPrediction")
install.packages("FeatureExtraction") 
install.packages("Andromeda") 
install.packages("dplyr") 
install.packages("Cyclops")
```

#### Load Libraries

```{r libraries, eval=TRUE}
library(usethis)
library(DatabaseConnector)
library(ETLSyntheaBuilder)
library(SqlRender)
library(devtools) 
library(dplyr)
library(Andromeda)
library(FeatureExtraction) 
library(Cyclops)
library(PatientLevelPrediction)
```

#### Make connection with PostgreSQL

Enter your server details below.

```{r connection details, eval=TRUE}
cd <- DatabaseConnector::createConnectionDetails(
  dbms     = "postgresql", 
  server   = "localhost/postgres", 
  user     = "postgres", 
  password = "Bornon22121996!", 
  port     = 5432)
conn <- connect(cd)
```

### Create the Common Data Model

#### Create schemas for Common Data Model, vocabularies and csv files
_execute this command only if schemas do not exist, otherwise it will throw an error_

```{r create schemas, eval=TRUE}
sql <- "create schema cdm_precision_test;
create schema precision_native_test;"
renderTranslateExecuteSql(conn, sql)
```

#### Drop all existing tables 

```{r drop existing tables, eval=TRUE}
ETLSyntheaBuilder::DropVocabTables(connectionDetails = cd, vocabDatabaseSchema = "cdm_precision_test")
ETLSyntheaBuilder::DropEventTables(connectionDetails = cd, cdmDatabaseSchema = "cdm_precision_test")
ETLSyntheaBuilder::DropSyntheaTables(connectionDetails = cd, syntheaDatabaseSchema = "precision_native_test")
ETLSyntheaBuilder::DropMapAndRollupTables (connectionDetails = cd, cdmDatabaseSchema = "cdm_precision_test")
```

#### Import csv files

syntheaFileLoc: location of input csv files

_Delete the Organizations column from encounters.csv_

```{r import csv files, eval=TRUE}
ETLSyntheaBuilder::CreateSyntheaTables(connectionDetails = cd, syntheaDatabaseSchema = "precision_native_test")
ETLSyntheaBuilder::LoadSyntheaTables(connectionDetails = cd, syntheaDatabaseSchema = "precision_native_test", syntheaFileLoc = "C:/Users/misrap/Desktop/COVID/precisionFDA/test") 
```

#### Create vocabulary tables

```{r create vocabulary tables, eval=FALSE}
ETLSyntheaBuilder::CreateVocabTables(connectionDetails = cd, vocabDatabaseSchema = "cdm_precision_test")
```

#### Change type of concept_name and concept_synonym_name to text

```{r change type, eval=TRUE}
sql <- "alter table @cdm.concept alter column concept_name type text;
alter table @cdm.concept_synonym alter column concept_synonym_name type text;"
renderTranslateExecuteSql(conn, sql, cdm = "cdm_precision_test")
```

#### Load vocabulary tables

vocabFileLoc: location of vocabulary files

```{r load vocabulary tables, eval=FALSE}
ETLSyntheaBuilder::LoadVocabFromCsv(connectionDetails = cd, cdmDatabaseSchema = "cdm_precision_test", vocabFileLoc = "C:/Users/misrap/Desktop/COVID/precisionFDA/vocabulary_v5") 
```

#### Build the Common Data Model

```{r CDM Builder, eval=TRUE}
ETLSyntheaBuilder::CreateVocabMapTables(connectionDetails = cd, cdmDatabaseSchema = "cdm_precision_test")
ETLSyntheaBuilder::CreateEventTables(connectionDetails = cd, cdmDatabaseSchema = "cdm_precision_test")
ETLSyntheaBuilder::CreateVisitRollupTables(cd, cdmDatabaseSchema = "cdm_precision_test", syntheaDatabaseSchema = "precision_native_test")
ETLSyntheaBuilder::LoadEventTables(cd, cdmDatabaseSchema = "cdm_precision_test", syntheaDatabaseSchema = "precision_native_test", vocabDatabaseSchema = "cdm_precision_test")
```

#### Change names of a few columns

```{r change names, eval=TRUE}
sql <- "alter table cdm_precision_test.condition_era rename column condition_era_start_datetime to condition_era_start_date;
alter table cdm_precision_test.condition_era rename column condition_era_end_datetime to condition_era_end_date;
alter table cdm_precision_test.drug_era rename column drug_era_start_datetime to drug_era_start_date;
alter table cdm_precision_test.drug_era rename column drug_era_end_datetime to drug_era_end_date;"
renderTranslateExecuteSql(conn, sql, cdm = "cdm_precision_test")
```

### Make Cohorts

#### Make cohort table in cdm_precision_test schema

```{r create cohort table, eval=TRUE}
sql <- "drop table if exists @cdm.cohort;
CREATE TABLE @cdm.cohort (  subject_id bigint,  cohort_start_date date, cohort_end_date date,  cohort_definition_id integer);"
renderTranslateExecuteSql(conn, sql, cdm = "cdm_precision_test")
```

#### Cohort 1: All patients

```{r create cohort 1, eval=TRUE}
sql <- "SELECT person_id AS subject_id,
 condition_start_date AS cohort_start_date,
 condition_end_date AS cohort_end_date
INTO #diagnoses
FROM @cdm.condition_occurrence
WHERE condition_concept_id IN (
   SELECT descendant_concept_id
   FROM @cdm.concept_ancestor
);"
renderTranslateExecuteSql(conn, sql, cdm = "cdm_precision_test")

sql <- "INSERT INTO @cdm.cohort (
  subject_id, 
  cohort_start_date,
  cohort_end_date,
  cohort_definition_id
  )
SELECT subject_id,
  cohort_start_date,
  cohort_end_date,
  CAST (1 AS INT) AS cohort_definition_id
FROM #diagnoses;"
renderTranslateExecuteSql(conn, sql, cdm = "cdm_precision_test")

sql <- "TRUNCATE TABLE #diagnoses;
DROP TABLE #diagnoses;"
renderTranslateExecuteSql(conn, sql)
```

#### Cohort 2: All patients

```{r create cohort 2, eval=TRUE}
sql <- "SELECT person_id AS subject_id,
 condition_start_date AS cohort_start_date,
 condition_end_date AS cohort_end_date
INTO #diagnoses
FROM @cdm.condition_occurrence
WHERE condition_concept_id IN (
   SELECT descendant_concept_id
   FROM @cdm.concept_ancestor
);"
renderTranslateExecuteSql(conn, sql, cdm = "cdm_precision_test")

sql <- "INSERT INTO @cdm.cohort (
  subject_id, 
  cohort_start_date,
  cohort_end_date,
  cohort_definition_id
  )
SELECT subject_id,
  cohort_start_date,
  cohort_end_date,
  CAST (2 AS INT) AS cohort_definition_id
FROM #diagnoses;"
renderTranslateExecuteSql(conn, sql, cdm = "cdm_precision_test")

sql <- "TRUNCATE TABLE #diagnoses;
DROP TABLE #diagnoses;"
renderTranslateExecuteSql(conn, sql)
```

### Covariate settings

```{r covariate settings, eval=TRUE}
covSettings <- createCovariateSettings(useDemographicsGender = TRUE,
                                    useDemographicsAge = TRUE,
                                    useDemographicsRace = TRUE,
                                    useDemographicsEthnicity = TRUE,
                                    useDemographicsIndexYear = TRUE,
                                    useConditionOccurrenceAnyTimePrior = TRUE,
                                    useConditionOccurrencePrimaryInpatientAnyTimePrior = TRUE,
                                    useConditionEraAnyTimePrior = TRUE,
                                    useConditionGroupEraAnyTimePrior = TRUE,
                                    useDrugExposureAnyTimePrior = TRUE,
                                    useDrugEraAnyTimePrior = TRUE,
                                    useDrugGroupEraAnyTimePrior = TRUE,
                                    useProcedureOccurrenceAnyTimePrior = TRUE,
                                    useDeviceExposureAnyTimePrior = TRUE,
                                    useMeasurementAnyTimePrior = TRUE,
                                    useMeasurementValueAnyTimePrior = TRUE,
                                    useMeasurementRangeGroupAnyTimePrior = TRUE,
                                    useObservationAnyTimePrior = TRUE,
                                    useCharlsonIndex = TRUE,
                                    useDcsi = TRUE,
                                    useChads2 = TRUE,
                                    useChads2Vasc = TRUE,
                                    useHfrs = TRUE,
                                    useDistinctConditionCountLongTerm = TRUE,
                                    useDistinctIngredientCountLongTerm = TRUE,
                                    useDistinctProcedureCountLongTerm = TRUE,
                                    useDistinctMeasurementCountLongTerm = TRUE,
                                    useDistinctObservationCountLongTerm = TRUE,
                                    useVisitCountLongTerm = TRUE,
                                    useVisitConceptCountLongTerm = TRUE,
                                    longTermStartDays = -365,
                                    endDays = 0)
```

### Extract cohort data from cdm_precision_test schema

```{r extract cohort data, eval=TRUE}
plpData <- getPlpData(connectionDetails = cd,
                      cdmDatabaseSchema = "cdm_precision_test",
                      cohortDatabaseSchema = "cdm_precision_test",
                      cohortTable = "cohort",
                      cohortId = 1,
                      covariateSettings = covSettings,
                      outcomeDatabaseSchema = "cdm_precision_test",
                      outcomeTable = "cohort",
                      outcomeIds = 2)

summary(plpData)
```

savePlpData(plpData,"C:/Users/misrap/Desktop/COVID/precisionFDA/plpData/plpData_test_Jul2_AllPatients_AllPatients_corrected")

### Create a study population

```{r create study population, eval=TRUE}
population <- createStudyPopulation(plpData = plpData,
                                    outcomeId = 2,
                                    includeAllOutcomes = TRUE,
                                    firstExposureOnly = TRUE,
                                    washoutPeriod = 0,
                                    removeSubjectsWithPriorOutcome = FALSE,
                                    priorOutcomeLookback = 9999,
                                    requireTimeAtRisk = TRUE,
                                    minTimeAtRisk = 0,
                                    riskWindowStart = 0,
                                    riskWindowEnd = 365)

nrow(population)
```

### Making Predictions

```{r Random Forest Model, eval=TRUE}

# load the model and data
plpData <- loadPlpData("C:/Users/misrap/Desktop/COVID/precisionFDA/FinalSubmission_Jul2/plpData/plpData_test_Jul2_AllPatients_AllPatients_corrected")
plpModel <- loadPlpModel("./FinalSubmission_Jul2/ML_model/RandomForest_AllPatients_COVIDVent_newCov_newPar_exclude_more/plpResult/model")

# Go back up and create population!!

Prediction <- predictPlp(plpModel, population, plpData, index = NULL)

savePrediction(Prediction, "C:/Users/misrap/Desktop/COVID/precisionFDA/FinalSubmission_Jul2/Predictions_csv", fileName =
                 "prediction_Jul2_AllPatients_COVIDVent.rds")

##### if command for population inclusion
# 
# # use the same population settings as the model:
# populationSettings <- plpModel$populationSettings
# populationSettings$plpData <- plpData
# population <- do.call(createStudyPopulation, populationSettings)
# 
# ## apply model
# appliedModel <- applyModel(population = population, plpData = plpData, plpModel = plpModel, calculatePerformance = F)
```

